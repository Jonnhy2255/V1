<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Uploader Avatar Base64 avec Logs</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDP1A9T03YoMhiTAxlGLv_6Tz7gHrdF9y0",
      authDomain: "betxchange-5f315.firebaseapp.com",
      projectId: "betxchange-5f315",
      storageBucket: "betxchange-5f315.appspot.com",
      messagingSenderId: "157220736694",
      appId: "1:157220736694:web:b3a8d9b65c7f54de28c5a0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        showLog("Utilisateur connecté : " + user.email, "info");
        loadAvatar();
      } else {
        showLog("Connecte-toi d'abord !", "error");
      }
    });

    async function loadAvatar() {
      try {
        const docRef = doc(db, "users", currentUser.uid);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.avatar) {
            document.getElementById('avatar-img').src = data.avatar;
            document.getElementById('delete-btn').style.display = 'inline-block';
            showLog("Avatar chargé avec succès.", "success");
          } else {
            showLog("Aucun avatar trouvé.", "info");
          }
        }
      } catch (err) {
        console.error(err);
        showLog("Erreur en chargeant l'avatar.", "error");
      }
    }

    async function uploadAvatar(file) {
      const reader = new FileReader();
      reader.onload = async function (e) {
        const base64 = e.target.result;
        try {
          await updateDoc(doc(db, "users", currentUser.uid), { avatar: base64 });
          document.getElementById('avatar-img').src = base64;
          document.getElementById('delete-btn').style.display = 'inline-block';
          showLog("Avatar uploadé avec succès !", "success");
        } catch (err) {
          console.error(err);
          showLog("Erreur lors de l'upload de l'avatar.", "error");
        }
      };
      reader.readAsDataURL(file);
    }

    async function deleteAvatar() {
      try {
        await updateDoc(doc(db, "users", currentUser.uid), { avatar: "" });
        document.getElementById('avatar-img').src = "";
        document.getElementById('delete-btn').style.display = 'none';
        showLog("Avatar supprimé !", "success");
      } catch (err) {
        console.error(err);
        showLog("Erreur lors de la suppression.", "error");
      }
    }

    window.handleFileChange = function(event) {
      const file = event.target.files[0];
      if (file) {
        uploadAvatar(file);
      } else {
        showLog("Aucun fichier sélectionné.", "info");
      }
    };

    window.deleteAvatar = deleteAvatar;

    // Fonction pour afficher un log visuel
    function showLog(message, type = "info") {
      const log = document.createElement("div");
      log.textContent = message;
      log.className = "log-message " + type;
      document.getElementById('log-container').appendChild(log);

      // Auto-effacer après 5 secondes
      setTimeout(() => {
        log.remove();
      }, 5000);
    }
  </script>

  <style>
    body {
      text-align: center;
      padding: 50px;
      font-family: Arial, sans-serif;
    }
    #avatar-img {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: #eee;
      object-fit: cover;
      margin-bottom: 10px;
    }
    #delete-btn {
      display: none;
      margin-top: 10px;
    }
    #log-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      pointer-events: none;
    }
    .log-message {
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      width: fit-content;
      max-width: 90%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
      pointer-events: auto;
    }
    .log-message.success { background-color: #4CAF50; }
    .log-message.error { background-color: #F44336; }
    .log-message.info { background-color: #2196F3; }

    @keyframes fadeIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>

<body>
  <h2>Uploader votre avatar</h2>

  <img id="avatar-img" src="" alt="Pas d'avatar" />
  <br/>

  <input type="file" accept="image/*" onchange="handleFileChange(event)" />
  <br/>

  <button id="delete-btn" onclick="deleteAvatar()">Supprimer l'avatar</button>

  <!-- Conteneur pour les logs visuels -->
  <div id="log-container"></div>
</body>
</html>
